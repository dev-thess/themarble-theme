name: Deploy Theme to Shopify

on:
  push:
    branches:
      - prod

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install Theme Kit
        run: |
          echo "Installing Theme Kit..."
          curl -s https://shopify.github.io/themekit/scripts/install.py | python3
          echo "Theme Kit version:"
          theme version

      - name: Deploy to Shopify via Theme Kit
        env:
          SHOPIFY_PASSWORD: ${{ secrets.SHOPIFY_ADMIN_TOKEN }}
          SHOPIFY_STORE: ${{ secrets.SHOPIFY_STORE_DOMAIN }}
        run: |
          set -e

          echo "Authenticating with Shopify..."
          echo "Using store: $SHOPIFY_STORE"

          # build a unique name for this deploy
          SHORT_SHA=${GITHUB_SHA:0:7}
          TIMESTAMP=$(date +%Y%m%d%H%M)
          THEME_NAME="Marble-Theme-$SHORT_SHA-$TIMESTAMP"
          echo "Deploying theme as '$THEME_NAME'..."

          # step 1: tạo theme mới (không phải publish luôn)
          echo "➤ Creating new theme..."
          theme new \
            --password="$SHOPIFY_PASSWORD" \
            --store="$SHOPIFY_STORE" \
            --name="$THEME_NAME" \
            --unpublished \
            --no-ignore  # ensure mọi file đều được include

          # step 2: lấy ID của theme vừa tạo
          echo "➤ Fetching the new theme ID..."
          THEME_ID=$(theme list -j \
            --password="$SHOPIFY_PASSWORD" \
            --store="$SHOPIFY_STORE" \
            | jq -r '.[0].id')

          if [[ -z "$THEME_ID" || "$THEME_ID" == "null" ]]; then
            echo "❌ Failed to retrieve theme ID. Aborting."
            exit 1
          fi
          echo "✔ Created theme with ID: $THEME_ID"

          # step 3: deploy toàn bộ file
          echo "➤ Deploying files to theme ID $THEME_ID..."
          theme deploy \
            --password="$SHOPIFY_PASSWORD" \
            --store="$SHOPIFY_STORE" \
            --themeid="$THEME_ID" \
            --allow-live \
            --no-ignore     # deploy cả những file mà .gitignore đang bỏ qua

          echo "✅ Theme deployment complete!"
          echo ""
          echo "→ Admin URL: https://$SHOPIFY_STORE/admin/themes/$THEME_ID"
          echo "→ Preview URL: https://$SHOPIFY_STORE/?preview_theme_id=$THEME_ID"
